<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innerself </title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div id="home" class="home-screen">
            <h1>InnerSelf âœ¨</h1>
            <p class="subtitle">A journey through present and future</p>

            <div class="home-buttons">
                <button class="btn btn-present" onclick="startQuiz('present')">Discover Present Self ğŸ“Œ</button>
                <button class="btn btn-future" onclick="startQuiz('future')">Discover Future Self ğŸ”®</button>
            </div>
        </div>

        <div id="imageUpload" class="quiz-container" style="display: none;">
            <div id="presentSection">
                <h3>Present Self</h3>
                <label>Upload your Business Card:</label>
                <input type="file" id="presentImage" accept="image/*" />
            </div>

            <div id="futureSection" style="display:none;">
                <h3>Future Self</h3>
                <label>Upload your Business Card:</label>
                <input type="file" id="futureImage" accept="image/*" />
            </div>

            <button class="btn-nav btn-next" id="nextBtnUpload" onclick="startQuestionnaire()"
                style="margin-top: 20px; margin-left: auto; display: block;">Next â†’</button>
        </div>

        <div id="quiz" class="quiz-container">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width:20%"></div>
            </div>

            <div id="questionCard" class="question-card fade-in">
                <div class="question-number" id="questionNumber">Question 1 of 5</div>
                <div class="question-text" id="questionText"></div>
                <input type="text" id="answerInput" placeholder="Type your answer here...">
            </div>

            <div class="navigation">
                <button class="btn-nav btn-back" id="backBtn" onclick="previousQuestion()">â† Back</button>
                <button class="btn-nav btn-next" id="nextBtnQuiz" onclick="nextQuestion()">Next â†’</button>
                <button class="btn btn-submit" id="submitBtn" onclick="finishQuiz()"
                    style="display:none; background-color: #28a745; color:white;">Submit âœ…</button>
            </div>
        </div>

        <div id="status" class="hidden">
            <a id="arCardLink" href="/business.html" target="_blank" class="btn-nav btn-next"
                style=" display: none; text-align: center; text-decoration: none; margin-bottom: 20px;">View AR Business
                Card
            </a>
            <div id="statusText">Starting...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="generationProgress"></div>
            </div>
        </div>

        <h2 id="identityTitle" class="identity-title" style="display: none;">Your Digital Identity - AR Style</h2>
        <img id="outputImage" alt="Generated image will appear here" />
        <div class="action-links">
            <a id="downloadLink" class="btn-nav btn-next" href="" download="model.glb">â¬‡ï¸ Download 3D Model</a>
            <a id="arLink" class="btn-nav btn-next" href="/ar.html" target="_blank">ğŸªŸ View AR Room</a>
        </div>
    </div>

    <script>
        const questions = {
            present: [
                "How would you describe yourself right now â€” your hairstyle, clothing, and small details?",
                "What are some words that best capture your current vibe or energy?",
                "What activity makes you lose track of time?",
                "What's a value you hold closest right now?",
                "What's one thing people often come to you for?"
            ],
            future: [
                "How would you like to look in the future â€” your hairstyle, clothing, or style that feels most like you a year from now?",
                "What are some words that best capture how you want to feel more often in the future?",
                "What's a hobby or skill you'd love future-you to explore or master?",
                "What's a quality you'd like to embody more strongly?",
                "If you could become known for one thing in the future, what would it be?"
            ]
        };

        let currentQuiz = '', currentQuestion = 0, answers = {};

        function startQuiz(type) {
            currentQuiz = type;

            // Show image upload section
            document.getElementById('home').classList.add('hidden');
            document.getElementById('imageUpload').style.display = 'block';

            // Show/hide appropriate image section
            document.getElementById('presentSection').style.display = (type === 'present') ? 'block' : 'none';
            document.getElementById('futureSection').style.display = (type === 'future') ? 'block' : 'none';
        }

        function startQuestionnaire() {
            currentQuestion = 0;
            answers = {};

            document.getElementById('imageUpload').style.display = 'none';
            document.getElementById('quiz').classList.remove('hidden');
            document.getElementById('quiz').classList.add('visible', 'fade-in');
            showQuestion();
        }

        function showQuestion() {
            document.getElementById('questionNumber').textContent = `Question ${currentQuestion + 1} of 5`;
            document.getElementById('questionText').textContent = questions[currentQuiz][currentQuestion];
            document.getElementById('answerInput').value = answers[currentQuestion] || '';
            document.getElementById('answerInput').focus();

            // Progress bar
            document.getElementById('progressFill').style.width = (((currentQuestion + 1) / 5) * 100) + '%';
            document.getElementById('backBtn').disabled = currentQuestion === 0;

            // Toggle buttons
            const nextBtn = document.getElementById('nextBtnQuiz');
            const submitBtn = document.getElementById('submitBtn');

            if (currentQuestion === 4) { // last question
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'inline-block';
                submitBtn.style.display = 'none';
                nextBtn.textContent = 'Next â†’';
            }

            // Fade-in animation
            const card = document.getElementById('questionCard');
            card.classList.remove('fade-in');
            setTimeout(() => { card.classList.add('fade-in'); }, 10);
        }



        function nextQuestion() {
            answers[currentQuestion] = document.getElementById('answerInput').value.trim();
            if (currentQuestion < 4) { currentQuestion++; showQuestion(); } else { finishQuiz(); }
        }

        function previousQuestion() {
            if (currentQuestion > 0) { answers[currentQuestion] = document.getElementById('answerInput').value.trim(); currentQuestion--; showQuestion(); }
        }

        async function finishQuiz() {
            answers[currentQuestion] = document.getElementById('answerInput').value.trim();
            const answerArray = Object.values(answers);

            document.getElementById('quiz').classList.add('hidden');
            document.getElementById('status').classList.add('show');

            const statusText = document.getElementById('statusText');
            const progressFill = document.getElementById('generationProgress');
            const outputImage = document.getElementById('outputImage');
            const downloadLink = document.getElementById('downloadLink');
            const arLink = document.getElementById('arLink');
            const arCardLink = document.getElementById('arCardLink');

            // Show AR card button
            arCardLink.style.display = 'block';

            try {
                statusText.textContent = "Generating image & uploading...";
                progressFill.style.width = "10%";

                const startRes = await fetch("/api/start-glb", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ quizType: currentQuiz, answers: answerArray })
                });
                const startData = await startRes.json();
                if (!startData.success) throw new Error(startData.error || "Failed to start generation");

                outputImage.src = startData.imagePath + `?${Date.now()}`;
                outputImage.style.display = "block";
                document.getElementById('identityTitle').style.display = "block";
                progressFill.style.width = "30%";

                let done = false, progress = 30;
                while (!done) {
                    await new Promise(r => setTimeout(r, 3000));
                    const statusRes = await fetch(`/api/check-task/${startData.taskId}`);
                    const statusData = await statusRes.json();
                    if (statusData.status === "completed" || statusData.status === "success") {
                        progressFill.style.width = "100%";
                        downloadLink.href = statusData.glbUrl; downloadLink.style.display = "inline-block";
                        arLink.style.display = "inline-block"; statusText.textContent = "âœ… 3D model ready!"; done = true;
                    } else if (statusData.status === "failed") { statusText.textContent = "âœ— Task failed!"; done = true; }
                    else { progress = Math.min(progress + 5, 90); progressFill.style.width = progress + "%"; statusText.textContent = `Creating your AR Room...`; }
                }
            } catch (err) { statusText.textContent = "âœ— Error: " + err.message; }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('answerInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    if (currentQuestion === 4) {
                        finishQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            });
        });
    </script>
</body>

</html>